<?php


namespace rapidPHP\library\core\server;


use application\controller\ExceptionController;
use Co;
use rapidPHP\library\core\Router;
use rapidPHP\library\core\server\request\SHttpRequest;
use rapidPHP\library\core\server\response\SHttpResponse;
use Swoole\Http\Request as SwooleRequest;
use Swoole\Http\Response as SwooleResponse;
use Swoole\Http\Server;

abstract class SHttpServer extends SwooleServer
{

    /**
     * @var Server
     */
    private $server;

    /**
     * @return Server
     */
    public final function getServer()
    {
        return $this->server;
    }

    /**
     * 创建httpServer
     * @return $this
     */
    public final function create()
    {
        Co::set(['hook_flags' => SWOOLE_HOOK_ALL | SWOOLE_HOOK_CURL]);

        $this->server = new Server($this->getIp(), $this->getPort());

        return $this;
    }

    /**
     * 开启web服务，只能调用一次
     */
    public final function start()
    {
        $this->on("start", [$this, 'onStart']);

        $this->on("request", [$this, 'onRequest']);

        parent::start();
    }

    /**
     * httpServer开启
     * @param Server $server
     */
    public function onStart($server)
    {
        $host = $server->host;

        if ($host === '0.0.0.0') $host = '127.0.0.1';

        if ($server->port != 80) $host .= ':' . $server->port;

        echo "http server is started at http://{$host}\n";

        // TODO: Change the autogenerated stub
    }

    /**
     * 收到请求
     * @param SwooleRequest $req
     * @param SwooleResponse $res
     */
    public function onRequest(SwooleRequest $req, SwooleResponse $res)
    {
        // TODO: Change the autogenerated stub
    }
}